<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC 
	"-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd"
 >
 
 <!-- 누가 이 XML을 사용할까?(mybatis) / 누구와 연결을? (해당 DAO) -->
 <mapper namespace="com.market.rabbit.profile.dao.ProfileDAO1">
 
 	<!-- 위시리스트 -->
	<select id="wishlist" resultType="wish">
 		SELECT wish_idx,member_id,product_idx FROM WISH ORDER BY wish_idx DESC
 	</select>
 	
<!--  	<select id="sale" resultType="sale">
 		SELECT sale_subject,reg_date FROM sale ORDER BY reg_date DESC
 	</select>
 	
 	<select id="saleFile" resultType="saleFile">
 		SELECT * FROM sale_file WHERE newFileName=#{param1}
 	</select> -->
 	
 	<!-- 위시리스트 삭제 -->
 	<delete id="wishdelete">
 		DELETE FROM WISH WHERE wish_idx=#{param1}
 	</delete>
 	
 	<!-- 회원프로필 -->
 	<select id="profile" resultType="member">
 		SELECT member_id,address,manner_percent FROM MEMBER WHERE member_id=#{param1}
 	</select>
 	
 	<!-- 프로필사진 -->
 	<select id="fileList" resultType="profileFile">
 		SELECT * FROM PROFILEFILE WHERE member_id=#{param1}
 	</select>
 	
	<!-- 프로필 - 후기리스트 -->
	<select id="callProfileReviewList" resultType="review">
		SELECT *
		FROM (
		    SELECT review_idx, review_content, reg_date, member_id, write_id, ROW_NUMBER() OVER(ORDER BY reg_date DESC) AS rnum
		    FROM review
		    WHERE member_id=#{param1}
		    )
		WHERE rnum BETWEEN #{param2} AND #{param3}
	</select>
 	
 	<!-- 프로필 -> 판매내역리스트 -->
 	<select id="callProfileSaleList" resultMap="callProfileSaleListResult">
 		SELECT *
		FROM (
		    select ROW_NUMBER() OVER(ORDER BY file_idx desc) AS rnum, sale_subject, price, seller_id, product_idx, newfilename, file_idx, rnumFile,code_num,isdelete,isblind
		    FROM (
		        SELECT  s.sale_subject, s.price, s.seller_id, s.product_idx, sf.file_idx, RANK() OVER (PARTITION BY sf.product_idx ORDER BY sf.file_idx) rnumFile, sf.newfilename, s.code_num, s.isdelete, s.isblind
		        FROM sale s, sale_file sf
		        WHERE s.product_idx = sf.product_idx
		        )
		    WHERE rnumFile=1 AND seller_id=#{param1} AND code_num=3001 AND isdelete=0 AND isblind=0
		    )
		WHERE rnum between #{param2} and #{param3}
 	</select>
 	
 	<resultMap type="sale" id="callProfileSaleListResult">
	 	<id column="product_idx" property="product_idx"/>
	 	<result column="seller_id" property="seller_id"/>
	 	<result column="sale_subject" property="sale_subject"/>
	 	<result column="price" property="price"/>
	 	<result column="code_num" property="code_num"/>
	 	<association property="saleFileDto" javaType="saleFile">
	 		<result column="newFileName" property="newFileName"/>
	 		<result column="file_idx" property="file_idx"/>
	 	</association>
	</resultMap>
 
 	
 	<!-- 판매내역 상품사진 -->
 	<select id="salelistFile" resultType="saleFile">
 		SELECT * FROM sale_file WHERE newFileName=#{param1}
 	</select>
 	
 	<!-- 판매내역리스트 -->
 	<select id="salelistlist" resultType="sale">
 		SELECT product_idx,sale_subject,code_num,reg_date FROM sale WHERE sale_subject=#{param1}
 	</select>
 	
 	<!-- 거래상세보기(sale) -->
 	<select id="saledetail" resultType="sale">
 		SELECT sale_subject,price FROM sale WHERE sale_subject=#{param1}
 	</select>
 	
 	<!-- 거래상세보기(trading) -->
 	<select id="tradedetail" resultType="trading">
 		SELECT trade_state,seller_id,buyer_id,trade_type,trade_time,tracking_number,trade_start_date,trade_end_date,seller_manner,buyer_manner
 		FROM trading WHERE trade_state=#{param1}
 	</select>
 	
 	<!-- 프로필 sale 개수 -->
 	<select id="countAllSale" resultType="INTEGER">
 		SELECT count(product_idx) FROM sale WHERE seller_id=#{param1}
 	</select>
 	
 	<!-- 프로필 review 개수 -->
 	<select id="countAllReview" resultType="INTEGER">
 		SELECT count(review_idx) FROM review WHERE member_id=#{param1}
 	</select>
 	
 </mapper>